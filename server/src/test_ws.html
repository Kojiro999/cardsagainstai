<h1>Test Websocket Messaging</h1>
<div>
    <input id='gameId' placeholder="Game Id to join"/>
    <button id='joinGame'>Join Game</button>
</div>
<button id='createGame'>Create New Game</button>
<button id='addNewPlayer'>Add Player</button>
<button id='pickCzar'>Pick Czar</button>
<button id='startGame'>Start Game</button>
<button id='getGameObj'>Get Game Obj</button>
<button id='selectCard'>Select Random Card for player</button>

<div>
    <pre id='response' style='float: left; width: 50%'></pre>
    <pre id='gameDisplay' style='float: right; width: 50%'></pre>    
</div>
<!-- <input type='text' id='messageBox' placeholder='Type message here'></input> -->


<script>
    document.addEventListener('DOMContentLoaded', function(){
        let gameId = null;
        let playerId = null;
        let ws;

        function logEvent(response) {
            document.querySelector('#response').textContent += `- ${response}\n`
        }

        function displayGame(game) {
            // console.log(JSON.stringify(game, undefined, 2))
            let gameRep = []
            gameRep.push('Game id: ' + game.gameId)
            gameRep.push('Czar: ' + game.czar.playerId)
            gameRep.push('Players: ')
            game.players.forEach(player => {
                console.log("Player hand: " + player.hand)
                gameRep.push('\tPlayerId: ' + player.playerId)
                gameRep.push('\t\tCards: ' + player.hand.join(", "))
            });
            gameRep.push('Question Cards: \n\t' + game.board.questionCards.join(", "))
            gameRep.push('Answer Cards: \n\t' + game.board.answerCards.join(", "))
            document.querySelector('#gameDisplay').textContent = gameRep.join('\n')
        }

        function init() {
            if (ws) {
                ws.onerror = ws.onopen = ws.onclose = null;
                ws.close();
            }
            ws = new WebSocket('ws://localhost:8080');
            ws.onopen = () => {
                logEvent('Connection opened!')
                console.log('Connection opened!');
            }
            ws.onmessage = ({ data }) => handleResponse(data)
            ws.onclose = function() {
                ws = null;
            }
        }

        document.querySelector('#joinGame').onclick = function() {
            gameId = document.querySelector('#gameId').value
            sendRequest('joinGame')
        }
        document.querySelector('#createGame').onclick = function() { sendRequest('createGame') }
        document.querySelector('#addNewPlayer').onclick = function() { sendRequest('addNewPlayer') }
        document.querySelector('#pickCzar').onclick = function() { sendRequest('pickCzar') }
        document.querySelector('#startGame').onclick = function() { sendRequest('startGame') }
        document.querySelector('#getGameObj').onclick = function() { sendRequest('getGameObj') }
        document.querySelector('#selectCard').onclick = function() { sendRequest('selectCard') }

        function sendRequest(requestType) {
            if (!ws) {
                logEvent('No WebSocket connection')
                return;
            }
            
            switch (requestType) {
                case 'createGame':
                    data = {'requestType': requestType}
                    ws.send(JSON.stringify(data));
                    logEvent(`Sent ${requestType} request`)
                    break;
                case 'joinGame':
                case 'addNewPlayer':
                case 'pickCzar':
                case 'startGame':
                case 'getGameObj':
                    if (gameId == null) {
                        logEvent('Need to join or create a game before making player.')
                        return;
                    }
                    data = {'requestType': requestType, 'gameId': gameId}
                    ws.send(JSON.stringify(data));
                    logEvent(`Sent ${requestType} request to gameId:${gameId}`)
                    break;
                case 'selectCard':
                    selectedCardId = //TODO;
                    data = {'requestType': requestType, 'gameId': gameId, 'playerId': playerId, "cardId": selectedCardId}
                    ws.send(JSON.stringify(data))
                    logEvent(`Sent ${requestType} request to gameId:${gameId} usign playerId: ${playerId} cardId: ${selectedCardId}`)
                    break;
                default:
                    logEvent(`Not sure what to do with ${requestType}`)
                    return;
            }            
        }

        function handleResponse(data) {
            const response = JSON.parse(data)
            console.log('response.event = ' + response.event)
            // console.log('response: ' + JSON.stringify(response, undefined, 2))
            let game = null
            switch (response.event) {
                case 'connected':
                    logEvent('We are connected to the server!')
                    break;
                case 'gameCreated':
                    gameId = response.data.game.gameId
                    logEvent(`Game created with id: ${gameId}`)
                    break;
                case 'joinedGame':
                    playerId = response.data.player.playerId
                    logEvent(`Player created and joined with id: ${playerId}`)
                    break;
                case 'newPlayerAdded':
                    playerId = response.data.player.playerId
                    logEvent(`Player created and added with id: ${playerId}`)
                    break;
                case 'czarPicked':
                    if (response.data.chosen) {
                        logEvent('I am the chosen one!')
                    } else {
                        logEvent('I am NOT the chosen one :(')
                    }
                    break;
                case 'gameStarted':
                    game = response.data.game
                    // console.log(JSON.stringify(game, undefined, 2))
                    logEvent(`Started game with id ${game.gameId}`)
                    displayGame(game)
                    break;
                case 'retrievedGameObj':
                    game = response.data.game
                    logEvent(`Retrieved game with id ${game.gameId}`)
                    displayGame(game)
                    break;
                default:
                    logEvent(`Recieved: ${JSON.stringify(response, undefined, 2)}`);
            }
            
        }
        init();
    });
</script>